<!doctype html>
<head>
</head>
<body>
  <div style="width: 100vw; height: 80vh;">
    <div style="margin-left: auto; margin-right: auto; width: 1000px; margin-top: 20vh;">
      <canvas width="1000" height="1000" id="canvas" style="border: solid 1px black;">
      </canvas>
    </div>
  </div>

  <script>
    var socket = new WebSocket("ws://localhost:8765");

    var pong_arena = {
      canvas : document.getElementById("canvas"),
      keys : {},
      start : function() {
        this.canvas.width = 1000;
        this.canvas.height = 1000;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.interval = setInterval(game_loop, 20);
        window.addEventListener('keydown', function (e) {
          if (e.keyCode === 38 || e.keyCode === 40)
            e.preventDefault(); // prevents arrow scrolling while playing
          pong_arena.keys = (pong_arena.keys || []);
          pong_arena.keys[e.keyCode] = true;
        });
        window.addEventListener('keyup', function (e) {
          pong_arena.keys[e.keyCode] = false;
        });
      },
      clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
      }
    };

    function paddel(width, height, color, x, y) {
      this.width = width;
      this.height = height;
      this.x = x;
      this.y = y;
      this.score = 0;
      var ctx = pong_arena.context;
      ctx.fillStyle = color;
      ctx.fillRect(this.x, this.y, this.width, this.height);
    
      this.update = function() {
        ctx = pong_arena.context;
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
      }
    };

    function ball() {
      this.width = 10;
      this.height = 10;
      this.x = 500;
      this.y = 500;
      this.dirX = -2;
      this.dirY = 0.2;
      var ctx = pong_arena.context;
      ctx.fillStyle = "red";
      ctx.fillRect(this.x, this.y, this.width, this.height);
    
      this.update = function() {
        ctx = pong_arena.context;
        ctx.fillStyle = "red";
        ctx.fillRect(this.x, this.y, this.width, this.height);
      }

      this.collidesWith = function(otherobj) {
        var myleft = this.x;
        var myright = this.x + (this.width);
        var mytop = this.y;
        var mybottom = this.y + (this.height);
        var otherleft = otherobj.x;
        var otherright = otherobj.x + (otherobj.width);
        var othertop = otherobj.y;
        var otherbottom = otherobj.y + (otherobj.height);
        var crash = true;
        if ((mybottom < othertop) ||
        (mytop > otherbottom) ||
        (myright < otherleft) ||
        (myleft > otherright)) {
          crash = false;
        }
        return crash;
      }
    };

    function score(width, height, color, x, y, player) {
      this.width = width;
      this.height = height;
      this.x = x;
      this.y = y;
      this.player = player;
      this.update = function() {
        this.text = player.score;
        ctx = pong_arena.context;
          ctx.font = this.width + " " + this.height;
          ctx.fillStyle = color;
          ctx.fillText(this.text, this.x, this.y);
      }
    }
 
    async function startGame() {
      pong_arena.start();
      player1 = new paddel(10, 100, "black", 100, 450);
      player2 = new paddel(10, 100, "black", 900, 450);
      score1 = new score("30px", "Consolas", "black", 100, 100, player1);
      score2 = new score("30px", "Consolas", "black", 900, 100, player2);
      ball = new ball();
    }

    function increase_ball_speed(ball) {
      if (ball.dirX > 0)
        ball.dirX += 0.001;
      else
        ball.dirX -= 0.001;
    }

    function move_ball(ball) {
      ball.x += ball.dirX;
      ball.y += ball.dirY;
    }

    function handle_player_movement(player1) {
      if (pong_arena.keys[87])
      {
        console.log("up");
        socket.send("up");
      }
      if (pong_arena.keys[83])
      {
        console.log("down");
        socket.send("down");
      }
    }

    function handle_collision() {
      if (ball.y < 0 || ball.y > 1000)
        ball.dirY = -ball.dirY;
      if (ball.collidesWith(player1))
      {
        ball.dirY += 3 * (0.01 * (ball.y - player1.y) - 0.5);
        ball.dirX = Math.abs(ball.dirX) + 0.01;
        ball.x = 111;
      }
    }

    function handle_point() {
      if (ball.x < 0)
      {
        player1.score++;
        ball.x = 500;
        ball.y = 500;
      }
    }

    function game_loop() {
      move_ball(ball);
      increase_ball_speed(ball);
      handle_player_movement(player1);
      handle_collision();
      handle_point();
      pong_arena.clear();
      player1.update();
      player2.update();
      score1.update();
      ball.update();
    }

    let name = window.prompt("Pls type your name", "j1");
    socket.onmessage = function (event) {
      console.log(event.data);
      if (event.data.startsWith("j1:"))
      {
        if (event.data.endsWith("down"))
          player1.y += 10;
        else
          player1.y -= 10;

        if (player1.y < 0)
          player1.y = 0;
        if (player1.y > 900)
          player1.y = 900;
      }
      if (event.data.startsWith("j2:"))
      {
        if (event.data.endsWith("down"))
          player2.y += 10;
        else
          player2.y -= 10;

        if (player2.y < 0)
          player2.y = 0;
        if (player2.y > 900)
          player2.y = 900;
      }
    }
    socket.send(name);
    startGame();

  </script>
</body>
